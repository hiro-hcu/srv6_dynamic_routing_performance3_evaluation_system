# SRv6 Multi-Table Manager 関数分析

> **対象ファイル**: `phase3_realtime_multi_table.py`  
> **最終更新**: 可視化機能対応版

---

## 📊 プログラム構造概要

### 🏗️ クラス設計

本システムは**単一責任原則（SRP）**に基づき、各クラスが明確な役割を持つよう設計されています。

#### データクラス

| クラス名 | 役割 |
|----------|------|
| `SRv6Config` | 統合設定管理（SSH、セグメント、テーブル定義、RRDパス） |
| `TableRoute` | テーブル経路情報（パス、SID、インターフェース、コスト） |
| `PathChangeEvent` | 経路変更イベント記録 |

#### 機能別クラス

| クラス名 | 役割 | 主要技術 |
|----------|------|----------|
| `RRDDataManager` | RRDデータ取得・エッジ重み更新 | 利用率ベース計算 |
| `PathCalculator` | 経路計算・SIDリスト生成 | Dijkstra法 + 重み倍率 |
| `TopologyVisualizer` | ネットワークトポロジ可視化 | NetworkX + matplotlib |
| `SSHConnectionManager` | SSH接続・コマンド実行 | Paramiko |
| `RoutingTableManager` | ルーティングテーブル更新 | iproute2 |

#### メインクラス

| クラス名 | 役割 | 備考 |
|----------|------|------|
| `SRv6PathManager` | 双方向パス管理 + 可視化 | 推奨 |
| `SRv6RealTimeMultiTableManager` | リアルタイム監視 | 互換性維持用 |

---

## 🔄 関数依存関係図

```
main()
├── SRv6PathManager（双方向モード + 可視化）
│   │
│   ├─[1] RRDDataManager.update_edge_weights()
│   │      └── fetch_rrd_data()  ← 全エッジに対して実行
│   │
│   ├─[2] PathCalculator.calculate_multiple_paths()
│   │      └── path_to_sid_list()  ← 各経路に対して実行
│   │
│   ├─[3] SRv6PathManager.create_table_routes()
│   │      └── 計算済み経路（self.calculated_paths）を再利用
│   │
│   ├─[4] RoutingTableManager.update_all_tables()
│   │      ├── SSHConnectionManager.r1_connection()  ← 往路
│   │      ├── SSHConnectionManager.r16_connection() ← 復路
│   │      └── SSHConnectionManager.execute_command()
│   │
│   └─[5] TopologyVisualizer.visualize()
│          └── 画像保存: /opt/app/visualization/topology_latest.png
│
└── SRv6RealTimeMultiTableManager（互換性維持用）
    └── real_time_monitor()
        ├── display_status()
        ├── detect_path_changes()
        ├── log_path_changes()
        └── 上記機能クラスに委譲
```

---

## 🔄 エッジ重みづけ〜経路決定の処理フロー

### 処理概要

利用率ベースの重みづけと Dijkstra 法による複数経路選択を実行し、優先度に応じた **3つの異なる経路** を決定します。

### フローチャート

```
┌─────────────────────────────────────────────────────────────────┐
│ [1] ネットワークトポロジ初期化                                 │
├─────────────────────────────────────────────────────────────────┤
│ PathCalculator._create_topology()                               │
│   ├─ 16ノード（r1〜r16）を 4×4 格子状に配置                     │
│   └─ 24エッジ作成                                               │
│       ├─ max_bandwidth = 125,000,000 Bytes/s（1Gbps）           │
│       └─ 初期重み = 0.0001（全エッジ）                          │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ [2] RRDデータ取得・エッジ重み更新                              │
├─────────────────────────────────────────────────────────────────┤
│ RRDDataManager.update_edge_weights(graph)                       │
│   │                                                             │
│   └─ 全エッジに対してループ:                                    │
│       ├─ fetch_rrd_data() → データ転送量取得 [Bytes/s]         │
│       ├─ 利用率計算: u = 転送量 / max_bandwidth                 │
│       │   └─ 範囲制限: max(0.0, min(1.0, u))                   │
│       └─ graph[u][v]['weight'] = max(u, 0.0001)                │
│           └─ 最小重み保証（経路多様性確保）                     │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ [3] 複数経路計算（優先度別、重複排除）                         │
├─────────────────────────────────────────────────────────────────┤
│ PathCalculator.calculate_multiple_paths(src=1, dst=16)          │
│   │                                                             │
│   ├─ temp_graph = self.graph.copy()  ← 作業用グラフ            │
│   ├─ weight_multipliers = [3.0, 2.0, 1.0]                      │
│   │                                                             │
│   └─ for i in range(3):  ← 3経路計算                           │
│       │                                                         │
│       ├─ [3-1] Dijkstra法で最短経路計算                         │
│       │   └─ コスト = 経路上の全エッジ重みの合計                │
│       │                                                         │
│       ├─ [3-2] 経路をリストに追加                               │
│       │                                                         │
│       ├─ [3-3] 詳細ログ出力（verbose=True時のみ）               │
│       │                                                         │
│       └─ [3-4] 使用エッジの重みを増加（次回計算用）             │
│           └─ 1経路目: ×3.0 / 2経路目: ×2.0                      │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ [4] 経路 → SRv6セグメントリスト変換                            │
├─────────────────────────────────────────────────────────────────┤
│ PathCalculator.path_to_sid_list(path, is_return=False)          │
│   │                                                             │
│   └─ 経路の各ホップに対して:                                    │
│       ├─ forward_segments から (SID, interface) を取得          │
│       ├─ sid_list.append(segment)                               │
│       └─ interface_list.append(interface)                       │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ [5] テーブルルート生成（計算済み経路の再利用）                  │
├─────────────────────────────────────────────────────────────────┤
│ SRv6PathManager.create_table_routes(optimal_path)               │
│   │                                                             │
│   └─ self.calculated_paths を使用（再計算なし）                 │
│       ├─ 各優先度に対して TableRoute オブジェクト生成           │
│       │   ├─ table_name: rt_table1/2/3                          │
│       │   ├─ path: ノードリスト                                 │
│       │   ├─ segments: SIDリスト                                │
│       │   ├─ output_interface: 最初のホップのインターフェース   │
│       │   └─ cost: 経路コスト                                   │
│       └─ 復路も同様（verbose=False で出力抑制）                 │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ [6] 可視化（--visualize オプション有効時）                     │
├─────────────────────────────────────────────────────────────────┤
│ TopologyVisualizer.visualize(paths, update_count)               │
│   │                                                             │
│   ├─ 格子状レイアウトでノード配置（4×4）                        │
│   ├─ 全エッジを灰色で描画                                       │
│   ├─ エッジラベル表示: "U:{利用率}\nC:{コスト}"                 │
│   ├─ 選択経路を色分け描画                                       │
│   │   ├─ 高優先度: 赤（幅4）                                    │
│   │   ├─ 中優先度: オレンジ（幅3）                              │
│   │   └─ 低優先度: 緑（幅2）                                    │
│   ├─ 凡例に経路情報表示（総コスト、平均エッジコスト）           │
│   └─ PNG画像として保存                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📝 3経路決定プロセスの具体例

### 初期状態

| エッジ | 利用率 | 備考 |
|--------|--------|------|
| r1-r2 | 0.0001 | データなし（最小重み保証） |
| r1-r3 | 0.0001 | データなし |
| r2-r5 | 0.0001 | データなし |
| ... | 0.0001 | 全エッジが 0.0001 から開始 |

> **最小重み保証**: RRDデータがない場合やトラフィックが0でも、最小重み 0.0001 により経路の多様性を確保

---

### 経路1（高優先度）の決定

**Step 1: Dijkstra法実行**
- 全エッジが同じ重みのため、最短ホップ数の経路が選択される
- 選択経路: `r1 → r3 → r6 → r10 → r13 → r15 → r16`
- コスト: `0.0001 × 6 = 0.0006`

**Step 2: 使用エッジの重み更新（×3.0）**

| エッジ | 更新前 | 更新後 |
|--------|--------|--------|
| r1-r3 | 0.0001 | 0.0003 |
| r3-r6 | 0.0001 | 0.0003 |
| r6-r10 | 0.0001 | 0.0003 |
| r10-r13 | 0.0001 | 0.0003 |
| r13-r15 | 0.0001 | 0.0003 |
| r15-r16 | 0.0001 | 0.0003 |

---

### 経路2（中優先度）の決定

**Step 1: Dijkstra法実行**（更新後の重み使用）
- 経路1で重みが3倍になったため、別経路が選択される
- 選択経路: `r1 → r2 → r5 → r9 → r13 → r15 → r16`
- コスト: `0.0001 × 5 + 0.0003 × 2 = 0.0011`（r13-r15, r15-r16 は共有）

**Step 2: 使用エッジの重み更新（×2.0）**

| エッジ | 更新前 | 更新後 | 備考 |
|--------|--------|--------|------|
| r1-r2 | 0.0001 | 0.0002 | 新規使用 |
| r2-r5 | 0.0001 | 0.0002 | 新規使用 |
| r5-r9 | 0.0001 | 0.0002 | 新規使用 |
| r9-r13 | 0.0001 | 0.0002 | 新規使用 |
| r13-r15 | 0.0003 | 0.0006 | さらに2倍 |
| r15-r16 | 0.0003 | 0.0006 | さらに2倍 |

---

### 経路3（低優先度）の決定

**Step 1: Dijkstra法実行**（さらに更新後の重み使用）
- 経路1・2で重みが増加したため、さらに別経路が選択される
- 選択経路: `r1 → r2 → r4 → r7 → r11 → r14 → r16`
- コスト: `0.0002 + 0.0001 × 5 = 0.0007`（r1-r2 は経路2で2倍、残りは未使用）

**Step 2: 重み更新なし**（最後の経路のため）

---

### 実トラフィックがある場合の例

| エッジ | 利用率 | 備考 |
|--------|--------|------|
| r1-r2 | 0.05 | 5% 使用 |
| r1-r3 | 0.10 | 10% 使用 |
| r2-r5 | 0.08 | 8% 使用 |
| r3-r5 | 0.03 | 3% 使用 |
| r5-r9 | 0.12 | 12% 使用 |
| r6-r10 | 0.02 | 2% 使用 |

- **低負荷リンクを優先的に選択**
- 経路1で使用したリンクは重みが3倍になり、経路2・3では回避される傾向

---
```
エッジ利用率（RRDデータから取得）:
  r1-r2: 0.05 (5%使用)   r1-r3: 0.10 (10%使用)
  r2-r5: 0.08 (8%使用)   r3-r5: 0.03 (3%使用)
  r5-r9: 0.12 (12%使用)  r6-r10: 0.02 (2%使用)
  ... (トラフィックに応じた利用率)

→ 低負荷リンクを優先的に選択
→ 経路1で使用したリンクは重みが3倍になり、経路2・3では回避される傾向
```

## ⚙️ 重みづけアルゴリズム

### 利用率の正規化（0〜1の範囲）

```python
# データ転送量から利用率を計算
utilization = データ転送量 (Bytes/s) / 最大帯域幅 (125,000,000 Bytes/s)
utilization = max(0.0, min(1.0, utilization))  # 0〜1にクリップ
```

### 最小重み保証（0.0001）

```python
min_weight = 0.0001
graph[u][v]['weight'] = max(utilization, min_weight)
```

| 効果 | 説明 |
|------|------|
| ゼロ回避 | トラフィックが0でも重みが0にならない |
| 耐障害性 | RRDデータ取得失敗時も動作継続 |
| 数値安定性 | 重み倍率適用時も非ゼロの値が保証 |
| 経路多様性 | 3つの経路が必ず異なる経路を選択可能 |

### 重みの倍率適用

```python
new_weight = old_weight * multiplier  # 上限制限なし
```

| 例 | 利用率 | 1回目使用後 | 2回目使用後 |
|----|--------|-------------|-------------|
| 最小重み | 0.0001 | 0.0003（×3.0） | 0.0006（×2.0） |
| 利用率50% | 0.5 | 1.5（×3.0） | 3.0（×2.0） |

### 経路多様性確保メカニズム

| 優先度 | 経路選択基準 | ペナルティ |
|--------|--------------|------------|
| 高（1経路目） | 最も低負荷な経路を選択 | なし |
| 中（2経路目） | 1経路目のリンクを回避傾向 | 重み ×3.0 |
| 低（3経路目） | 1・2経路目のリンクを回避傾向 | 重み ×3.0 + ×2.0 |

### ログ出力の最適化

| 方向 | verbose | 出力内容 |
|------|---------|----------|
| 往路 | True | 詳細な経路情報とエッジコストを出力 |
| 復路 | False | 出力を抑制（ログの見やすさ向上） |

---

## 📋 クラス別機能解析

### 🗄️ RRDDataManager

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `__init__(config)` | 初期化 | RRDファイルパス設定、取得カウンター |
| `update_edge_weights(graph)` | エッジ重み更新 | 60秒間隔で実行、最小重み保証（0.0001） |
| `fetch_rrd_data(rrd_path)` | RRDデータ取得 | 戻り値: Bytes/s または None |

---

### 🧮 PathCalculator

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `__init__(config)` | 初期化 | トポロジー管理（4×4格子、16ノード、24エッジ） |
| `_create_topology()` | トポロジー作成 | 初期重み 0.0001、帯域幅 125MB/s |
| `calculate_multiple_paths(...)` | 複数経路生成 | Dijkstra法 + 重み倍率（3.0, 2.0, 1.0） |
| `path_to_sid_list(path, is_return)` | SID変換 | ノードパス → SRv6セグメントIDリスト |

---

### 🎨 TopologyVisualizer

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `__init__(graph, output_dir)` | 初期化 | 出力先: `/opt/app/visualization` |
| `_setup_figure()` | 図設定 | 4×4格子状レイアウト |
| `visualize(paths, update_count)` | 可視化 | 経路色分け（赤/オレンジ/緑）、PNG保存 |
| `close()` | クリーンアップ | メモリ解放 |

**ノード配置レイアウト:**
```
r1   r2   r4   r7    (上段)
r3   r5   r8   r11   (2段目)
r6   r9   r12  r14   (3段目)
r10  r13  r15  r16   (下段)
```

---

### 🔗 SSHConnectionManager

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `__init__(config)` | 初期化 | ホスト、ユーザー、パスワード設定 |
| `r1_connection()` | r1接続 | コンテキストマネージャー対応 |
| `r16_connection()` | r16接続 | コンテキストマネージャー対応 |
| `execute_command(ssh, command)` | コマンド実行 | 戻り値: (stdout, stderr, exit_status) |

---

### 📋 RoutingTableManager

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `__init__(config)` | 初期化 | テーブル定義管理 |
| `create_table_routes(path, is_return)` | ルート生成 | パス → 3つの TableRoute オブジェクト |
| `clear_table_routes(client, table_name)` | ルートクリア | 既存ルート削除 |
| `update_table_route(client, table_route, is_return)` | ルート更新 | `ip -6 route` コマンド実行 |
| `update_all_tables(table_routes, is_return)` | 一括更新 | 全ルートを順次更新 |

---

### 🎯 SRv6PathManager（メインクラス）

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `__init__(enable_visualization)` | 初期化 | 全機能クラスのインスタンス化 |
| `update_bidirectional_tables()` | 双方向更新 | RRD取得→経路計算→テーブル更新→可視化 |
| `create_table_routes(optimal_path)` | ルート生成 | キャッシュ再利用（重複計算排除） |
| `visualize_network()` | ネットワーク可視化 | PNG出力 |

**update_bidirectional_tables() の処理フロー:**
1. RRDデータ取得・エッジ重み更新
2. 往路最適経路計算（3経路）
3. 復路経路は往路の逆順
4. r1 のテーブル更新（往路）
5. r16 のテーブル更新（復路）
6. 可視化更新（オプション）

---

### 🔄 SRv6RealTimeMultiTableManager（互換性維持）

| メソッド | 目的 | 詳細 |
|----------|------|------|
| `real_time_monitor()` | リアルタイム監視 | 従来インターフェース維持 |
| `detect_path_changes()` | 変更検出 | 差分監視 |
| `log_path_changes()` | ログ記録 | 変更履歴 |

---

## 🚀 最適化・可視化による改善点

### ✅ コード品質の改善

| 改善項目 | 内容 |
|----------|------|
| 責任分離 | 単一責任原則に基づくクラス分割 |
| 重複排除 | 計算済み経路の再利用（`self.calculated_paths`） |
| 保守性向上 | 各クラスが独立してテスト可能 |
| 拡張性 | 新機能追加時の影響範囲を限定 |
| 可視化機能 | `TopologyVisualizer` によるトポロジと経路の視覚化 |

### ⚡ 実行効率の向上

| 改善項目 | 内容 |
|----------|------|
| メモリ効率 | 設定情報の一元管理（`SRv6Config`） |
| 接続管理 | SSH接続のコンテキストマネージャー化 |
| エラーハンドリング | 各層での適切な例外処理 |
| 計算効率 | 経路計算結果のキャッシュ再利用 |
| ログ最適化 | verbose 制御（往路: 詳細、復路: 抑制） |

### 🎨 可視化機能

| 機能 | 詳細 |
|------|------|
| トポロジ表示 | 4×4格子状レイアウトで16ノード配置 |
| エッジ情報 | 利用率とコストを両方表示 |
| 経路色分け | 高（赤）、中（オレンジ）、低（緑）優先度 |
| ファイル出力 | PNG画像（GUI なし環境対応） |
| 更新履歴 | 更新回数と時刻をタイトルに表示 |

### 🔧 運用モード

| モード | クラス | 説明 |
|--------|--------|------|
| 双方向モード | `SRv6PathManager` | 完全な r1⇔r16 管理 + 可視化 |
| 従来モード | `SRv6RealTimeMultiTableManager` | 互換性維持 |
| 解析モード | `--mode analyze` | テーブル更新なし、経路計算のみ |

---

## 💾 主要データ構造

### 🏗️ SRv6Config（設定クラス）

```python
@dataclass
class SRv6Config:
    # SSH接続設定
    r1_host: str = "fd02:1::2"
    r16_host: str = "fd02:1::11"
    ssh_port: int = 22
    ssh_user: str = "root"
    ssh_password: str = "********"
    
    # ルーティング設定
    route_prefix: str = "fd03:1::/64"         # r1→r16方向（往路）
    return_route_prefix: str = "fd00:1::/64"  # r16→r1方向（復路）
    
    # テーブル定義
    tables: List[Dict] = [
        {"name": "rt_table1", "priority": "高優先度"},
        {"name": "rt_table2", "priority": "中優先度"},
        {"name": "rt_table3", "priority": "低優先度"}
    ]
    
    # RRDファイルパス（24エッジ）
    rrd_paths: Dict[Tuple[int, int], str]
    
    # セグメントマッピング
    forward_segments: Dict[int, Dict[int, Tuple[str, str]]]
    return_segments: Dict[int, Dict[int, Tuple[str, str]]]
```

### 📊 TableRoute（経路情報）

| フィールド | 型 | 説明 |
|------------|-----|------|
| `table_name` | str | テーブル名（rt_table1/2/3） |
| `priority` | str | 優先度（高/中/低） |
| `path` | List[int] | ノード経路 |
| `segments` | List[str] | SRv6セグメントIDリスト |
| `interfaces` | List[str] | インターフェースリスト |
| `output_interface` | str | 最初のホップの出力IF |
| `cost` | float | 経路コスト |
| `description` | str | 経路説明 |

### 📝 PathChangeEvent（変更イベント）

| フィールド | 型 | 説明 |
|------------|-----|------|
| `timestamp` | str | タイムスタンプ |
| `table_name` | str | テーブル名 |
| `old_path` | Optional[List[int]] | 旧経路 |
| `new_path` | List[int] | 新経路 |
| `old_segments` | Optional[List[str]] | 旧SIDリスト |
| `new_segments` | List[str] | 新SIDリスト |
| `reason` | str | 変更理由 |

### 🌐 ネットワークトポロジー

```python
# NetworkXグラフ（4×4格子状、16ノード、24エッジ）
edges = [
    (1, 2, {'weight': 0.0001, 'max_bandwidth': 125_000_000}),
    (1, 3, {'weight': 0.0001, 'max_bandwidth': 125_000_000}),
    # ... 全24エッジ
]

# RRDファイルマッピング
rrd_paths = {
    (1, 2): '/opt/app/mrtg/mrtg_file/r1-r2.rrd',
    (1, 3): '/opt/app/mrtg/mrtg_file/r1-r3.rrd',
    # ... 全24エッジ
}
```

---

## 🔄 実行フロー

### 双方向モード（推奨）

```
[初期化]
├─ 各機能クラスのインスタンス化
└─ TopologyVisualizer 初期化（--visualize 時）

[リアルタイムループ] ← 60秒間隔
├─[1] RRDDataManager
│     └─ エッジ重み更新（利用率ベース、最小重み 0.0001）
│
├─[2] PathCalculator
│     ├─ r1→r16 経路計算（3経路、重み倍率適用）
│     ├─ verbose=True: 詳細ログ出力
│     └─ self.calculated_paths にキャッシュ
│
├─[3] SRv6PathManager
│     └─ TableRoute 生成（キャッシュ再利用）
│
├─[4] SSHConnectionManager + RoutingTableManager
│     ├─ r1 接続 → 往路テーブル更新
│     └─ r16 接続 → 復路テーブル更新
│
├─[5] TopologyVisualizer（--visualize 時）
│     └─ 可視化更新・PNG 保存
│
└─ 次サイクルまで待機
```

### 従来モード（互換性維持）

| ステップ | 処理内容 |
|----------|----------|
| 1 | 既存インターフェース保持 |
| 2 | 各機能を新クラスに委譲 |
| 3 | `detect_path_changes()` による差分管理 |

### 解析モード

| ステップ | 処理内容 |
|----------|----------|
| 1 | RRDデータ取得・エッジ重み更新 |
| 2 | 経路計算のみ実行（テーブル更新なし） |
| 3 | 可視化ファイル生成（--visualize 時） |

---

## 🎯 設計思想と最適化

### クラス分離の効果

| クラス | 責務 | 効果 |
|--------|------|------|
| `RRDDataManager` | データ取得 | 独立性、最小重み保証 |
| `PathCalculator` | 経路計算 | アルゴリズム専門化 |
| `TopologyVisualizer` | 可視化 | matplotlib Agg対応 |
| `SSHConnectionManager` | 接続管理 | 安全性向上 |
| `RoutingTableManager` | テーブル操作 | 統一インターフェース |

### エラーハンドリング

| 状況 | 対応 |
|------|------|
| SSH接続失敗 | コンテキストマネージャーによる確実なクリーンアップ |
| RRDデータ取得失敗 | フォールバック（最小重み 0.0001） |
| matplotlib 警告 | 日本語フォント、Glyph 警告の抑制 |

### パフォーマンス

| 最適化項目 | 内容 |
|------------|------|
| 経路計算キャッシュ | `self.calculated_paths` による再利用 |
| 重複計算排除 | `create_table_routes` での再計算防止 |
| verbose 制御 | 往路のみ詳細ログ |
| 画像出力 | ファイル保存のみ（メモリ効率的） |